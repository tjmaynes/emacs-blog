version: 2
jobs:
  publish_blog:
    docker:
      - image: tjmaynes/blog-builder:latest
    working_directory: ~/blog
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-blog-elpa-cache
      - run:
          name: Publish Blog
          command: make publish_blog
      - save_cache:
          key: v1-blog-elpa-cache
          paths:
            - ~/.emacs.d/elpa
      - persist_to_workspace:
          root: ~/blog
          paths:
            - build/*
            - .git/*
  gh_pages_deploy:
    docker:
      - image: node:8.10.0
    working_directory: ~/blog
    environment:
      - GIT_USERNAME: tjmaynes-bot
      - GIT_EMAIL: tjmaynes+bot@gmail.com
      - GIT_COMMIT_SHA: ${CIRCLE_SHA1}
    steps:
      - checkout
      - attach_workspace:
          at: ~/blog
      - run:
          name: Deploy Blog to gh-pages branch
          command: make deploy_blog
workflows:
  version: 2
  publish_blog:
    jobs:
      - publish_blog:
          filters:
            branches:
              only: master
      - gh_pages_deploy:
          requires:
            - publish_blog
          filters:
            branches:
              only: master
